# NPAMetaExtractor | Извлекатор метаданных из НПА
Реализация задания TPC-2020

## Извлекаемые метаданные
* тип документа (федеральный закон, закон, указ, приказ, распоряжение, постановление)
* номер документа
* дата принятия (в формате dd.mm.yyyy)
* название документа
* орган, принявший акт (в нормализованном виде)

## Входные данные
Список строк, содержащих текст нормативно-правовых актов

## Выходные данные
Список JSON словарей следующего вида:
```python
{
    "type": "тип документа",
    "number": "номер документа",
    "date": "дата принятия",
    "name": "название документа",
    "authority": "принявший орган"
}
```

## Как запустить
```python
from solution import Solution
from typing import List


# implement your read_texts here
def read_texts() -> List[str]:
    return []


def main():
    texts = read_texts()
    solution = Solution()
    metadata = solution.predict(texts)


if __name__ == '__main__':
    main()
```

## Как работает извлекатор метаданных
Для извлечения каждого из полей испольщуется свой собственный извлекатор:
* для типа - `TypeExtractor`
* для номера - `NumberExtractor`
* для даты - `DateExtractor`
* для названия - `NameExtractor`
* для принявшего органа - `AuthorityExtractor`

### Исправление ошибок OCR
Поскольку большая часть текстов документов не имеет представления в виде текстового документа, текст получается
средствами OCR, из-за чего вносятся существенные ошибки. Для уменьшения влияния результата работы OCR создан
специальный нормализатор `TesseractNormalizer`. Он исправляет наиболее частые ошибки оптического распознавания текста и
выполняет замены на основе регулярных выражений.

Данный нормализатор имеет два режима работы: только замена с основными правилами или же обрезка различных некорректных
символов на границах строк и исправление слившихся дат.

### Различные форматы даты
Даты в документах записываются по-разному: 01.03.2010, 1 ноября 2020, 01 января 1998, 1/3/2020 и т.д.
Для приведения их к единому формату используется созданный нормализатор `DateNormalizer`.

В первую очередь нормализатор ищет в тексте подстроки, которые похожи на даты с помощью следующих регулярных выражений:
```python
date_regexps = [
    r"(?:\b[0-3ЗоОТб%]?[\dоОТб%].? *?[а-яА-Я][а-яА-Я]+[\n ]*?[12][09] ?\d ?\d)",
    r"(?:\b[0-3ЗоОТб%]?[\dоОТб%][./,\- ] ?[01оОТб%]?[\dоОТб%][./,\- ] ?[12][09] ?\d ?\d)"
]
```

После этого найденные даты приводятся к установленному формату путём замены месяцев на их порядковые номера и замены
разделителей на точки. Строки, которые в результате такой замены не были приведены к "правильной" дате, или полученные
даты являются некорректными (например, 41 декабря 2020) заменяются строками `[error_date]`

### Нормализация номера документа
Для исправления небольшого количества OCR ошибок, связанных непосредственно с номерами докуметнов, используется
`NumberNormalizer`. Этот нормализатор удаляет некоторые слова из номера, а также выполняет набор звмен, используя
регцлярные выражения 

### Нормализация названия документа
Для удаления лишних частей названия, которые зачастую присутствуют в тексте документов, вроде "Принят", "Статья",
"Освободить" и т.д., был разработан `NameNormalizer`. Нормализатор выполняет набор замен на основе списка регулярных
выражений из `replace_regexps`, а также обрезает наименования по набору ключевых фраз из `stop_words`. Также
нормализатор имени заменяет два и более пробелов на 1

### Нормализация органа, принявшего акт
Поскольку в тексте принимающий орган практически никогда не нормализован, его приходится приводить к начальной форме,
для чего был создан `AuthorityNormalizer`. Данный нормализатор получает строку, в которой содержется найденное название
принявшего органа. Сначала нормализатор удаляет из строки все даты, удаляются лишние символы по краям и удаляются
некоторые часто используемые конструкции, определённые в `replace_regexps`, а затем выполняет замены различных форм
слов на исходные с помощью списка правил `normalize_regexps`. 

## Извлекатор типа
Поскольку НПА документы всё-таки довольно формализованы, но достаточно следующих правил:
* среди последних 40 строк есть строка, содержащая шаблон для законов `law_template`
* среди первых 15 строк содержится строка, полностью удовлетворяющая шаблону из `main_templates`
* в тексте, приведённом к нижнему регистру содержится шаблон из `lower_templates`
* среди всех строк имеется строка, которая начинается или заканчивается шаблоном из `main_templates`
* в тексте есть специальное правило для постановления `resolution_tempalte`
* если ничего не подошло, считается, что это приказ

## Извлекатор даты
В первую очередь в тексте документа ищутся все даты. Если найдена всего одна дата, то она и возвращается в качестве
ответа. Затем в зависимости от типа документов извлечение даты производится различными методами вида `extract_[type]`. 

Если дата так и не была найдена, среди всех найденных дат возвращается наиболее поздняя (максимальная).

### Извлечение даты для федеральных законов
Ищется первая строка с конца текста, в которой есть дата

### Извлечение даты для приказов
В первую очередь ищутся даты, подходящие под правило `order_regexps`. Затем, если ничего не нашлось, дата ищется среди
первых 5 строк.

### Извлечение даты для остальных типов
В остальных случаях дата извлекается похожим образом с добавлением специфических правил для данных документов.

## Извлекатор номера документа
Для некоторых типов документов заданы специальные регулярные выражения для номеров, а также имеется регулярное
выражение для произвольного номера - `default_regexp`. В первую очередь среди строк документов от последней к первой
ищется строка, содержащая внутренний номер. В случае обнаружения такой строки, из неё извлекается номер и возвращается
в качестве ответа.

Затем среди строк документа в прямом порядке ищется строка вида `от [дата принятия] №`. Если такая строка есть, то из
неё также извлекается сам номер и возвращается в качестве ответа. Также номер ищется и среди последних шести строк,
однако на этот раз только в виде номера без даты.

Если ничего не нашлось, номер ищется с помощью конкретных регулярных выражений для типов с помощью специального метода 
извлечения `extract_by_regexp`, который ищет строки в виде `[дата][разделитель][номер]`, удаляет дату и извлекает только
номер. Если в результате так ничего и не нашлось, то вернётся строка `unknown_Number`.

## Извлекатор названия документа
Поскольку в текстовом виде названия обычно занимают не одну, а несколько строк, в первую очередь текст разбивается на
параграфы с помощью регулярного выражения `paragraph_regexp`, а затем, если какой-то из параграфов закончился на запятую
или на "ого", то к нему добавляется следующий параграф. После этого текст получается объединением параграфов по "\n".

Для выделения имени среди полученного текста используется список регулярных выражений `name_regexps`. Как только
находится одна из подстрок, соответствующая одному из выражений, она нормализуется с помощью `NameNormalizer` и
возвращается в качестве ответа.

Если же имя так и не было найдено, возвращается строка "unknown name".

## Извлекатор органа, принявшего акт
Данный извлекатор использует информацию о типе документа. Если это федеральный закон, то всегда возвращается строка
`"Государственная Дума Федерального собрания Российской Федерации"`. Затем, аналогично извлечению имени, текст
разбивается на параграфы, из которых удаляются параграфы, содержащие мусор или символ номера (№).

С помощью регулярных выражений `authority_regexps` в тексте ищутся органы в различном виде. Если регулярное выражение
найдёт подходящую строку, то результат поиска будет передан в нормализатор органа `AuthorityNormalizer` и результат
нормализации будет возвращён в качестве ответа.

Если ни одно из выражений не подошло, то используются примитивные правила поиска автора непосредственно рядом с
названиями документов.
